# WhereEatAI - 智能旅游推荐系统技术架构

## 1. 项目概述

WhereEatAI是一个基于多Agent协作的智能旅游推荐系统，提供智能游记生成、动态行程规划、美食推荐、价格比价、内容识别等功能。

### 1.1 核心功能
- 🎯 **智能游记生成** - 基于用户偏好生成个性化游记
- 📅 **动态行程规划** - 实时调整的智能行程安排
- 🍽️ **附近美食推荐** - 基于位置的美食智能推荐
- 💰 **多平台价格比价** - 酒店、景点门票等价格对比
- 📝 **小红书笔记识别** - 提取小红书旅游笔记信息
- 🎬 **视频内容识别** - 分析旅游视频内容
- 🏷️ **专题推荐** - 基于主题的旅游推荐
- 🗺️ **旅行计划生成** - 包含美食、酒店、路线的完整计划

## 2. 技术选型

### 2.1 核心框架
- **编程语言**: Python 3.10+
- **多Agent编排**: LangChain + LangGraph
- **Agent协议**: A2A (Agent-to-Agent) Protocol
- **AI模型**: 硅基流动 - 千问系列模型（Qwen）
- **Web框架**: FastAPI
- **数据验证**: Pydantic

### 2.2 技术栈详细说明

#### 2.2.1 LangChain & LangGraph
```
- LangChain: 构建Agent基础能力
  - 统一的LLM接口
  - Prompt模板管理
  - 输出解析器
  - 链式调用

- LangGraph: 多Agent工作流编排
  - 有向图工作流
  - 状态管理
  - 条件路由
  - 并行执行
  - 循环检测
```

#### 2.2.2 A2A Agent协议
```
- Agent间通信标准化
- 消息格式统一
- 能力发现与注册
- 异步消息传递
- 错误处理与重试
```

#### 2.2.3 硅基流动千问模型
```
- 模型: Qwen/Qwen3-8B (可配置更大模型)
- API兼容: OpenAI格式
- 特性:
  - 中文理解能力强
  - 上下文长度大
  - 推理能力优秀
  - 响应速度快
```

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        App客户端层                            │
│  (iOS/Android/Web) - RESTful API调用                         │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                      API网关层 (FastAPI)                     │
│  - 请求路由                                                   │
│  - 参数验证                                                   │
│  - 认证授权                                                   │
│  - 限流控制                                                   │
│  - 日志记录                                                   │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                    Agent编排层 (LangGraph)                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              工作流状态管理                          │    │
│  │  - 输入数据       - 中间结果       - 最终输出        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Agent协作图 (StateGraph)                │    │
│  │                                                      │    │
│  │  START → 需求分析 → 并行执行 → 结果整合 → END        │    │
│  │              │                                       │    │
│  │              ├→ 游记生成Agent                        │    │
│  │              ├→ 行程规划Agent                        │    │
│  │              ├→ 美食推荐Agent                        │    │
│  │              ├→ 价格比价Agent                        │    │
│  │              ├→ 内容识别Agent                        │    │
│  │              └→ 专题推荐Agent                        │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                   Agent执行层 (A2A Protocol)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │游记生成Agent │  │行程规划Agent │  │美食推荐Agent │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │价格比价Agent │  │小红书Agent   │  │视频识别Agent │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │专题推荐Agent │  │旅行计划Agent │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                    模型服务层 (Qwen)                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │            硅基流动 API (OpenAI兼容)                 │    │
│  │  - 文本生成      - 对话补全      - 结构化输出       │    │
│  └─────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 Agent职责划分

| Agent名称 | 职责 | 输入 | 输出 |
|----------|------|------|------|
| TravelogueAgent | 智能游记生成 | 目的地、时长、兴趣 | 结构化游记内容 |
| ItineraryAgent | 动态行程规划 | 目的地、时间、偏好 | 每日详细行程 |
| FoodRecommendationAgent | 美食推荐 | 位置、菜系、预算 | 餐厅推荐列表 |
| PriceComparisonAgent | 价格比价 | 产品名、平台列表 | 价格对比结果 |
| XiaoHongShuAgent | 小红书识别 | 笔记内容、图片 | 提取的旅游信息 |
| VideoAgent | 视频识别 | 视频URL、摘要 | 视频内容分析 |
| TopicRecommendationAgent | 专题推荐 | 主题、兴趣 | 专题推荐内容 |
| TravelPlanAgent | 旅行计划 | 完整需求 | 综合旅行方案 |

### 3.3 工作流设计

#### 3.3.1 简单查询工作流
```
用户请求 → API验证 → 单个Agent执行 → 返回结果
```

#### 3.3.2 复杂规划工作流
```
用户请求 
  ↓
API验证
  ↓
LangGraph工作流启动
  ↓
├─ 并行阶段1: 信息收集
│  ├─ 小红书内容分析
│  ├─ 视频内容分析
│  └─ 专题推荐
  ↓
├─ 并行阶段2: 核心规划
│  ├─ 游记生成
│  ├─ 行程规划
│  └─ 美食推荐
  ↓
├─ 串行阶段3: 价格优化
│  └─ 价格比价
  ↓
├─ 整合阶段: 结果聚合
│  └─ 旅行计划生成
  ↓
返回完整方案
```

## 4. A2A协议设计

### 4.1 消息格式
```json
{
  "message_id": "uuid",
  "sender": "agent_name",
  "receiver": "agent_name",
  "timestamp": "ISO8601",
  "message_type": "request|response|notification",
  "payload": {
    "action": "execute|query|update",
    "data": {},
    "context": {}
  },
  "metadata": {
    "priority": "high|medium|low",
    "timeout": 30,
    "retry_count": 3
  }
}
```

### 4.2 Agent能力注册
```python
{
  "agent_id": "food_recommendation_agent",
  "capabilities": [
    {
      "name": "recommend_restaurants",
      "description": "推荐附近餐厅",
      "input_schema": {...},
      "output_schema": {...}
    }
  ],
  "status": "active",
  "load": 0.3
}
```

## 5. API设计

### 5.1 RESTful API规范

#### 5.1.1 通用响应格式
```json
{
  "status": "success|error",
  "message": "操作描述",
  "data": {},
  "timestamp": "2024-01-01T00:00:00Z",
  "request_id": "uuid"
}
```

#### 5.1.2 核心API端点

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| /api/v1/travel-plan | POST | 生成完整旅行计划 | ✓ |
| /api/v1/travelogue | POST | 生成游记 | ✓ |
| /api/v1/itinerary | POST | 生成行程 | ✓ |
| /api/v1/food/recommend | POST | 美食推荐 | ✓ |
| /api/v1/price/compare | POST | 价格比价 | ✓ |
| /api/v1/xiaohongshu/analyze | POST | 分析小红书 | ✓ |
| /api/v1/video/analyze | POST | 分析视频 | ✓ |
| /api/v1/topic/recommend | POST | 专题推荐 | ✓ |
| /api/v1/health | GET | 健康检查 | × |
| /api/v1/agents | GET | Agent列表 | × |

## 6. 数据模型

### 6.1 请求模型
```python
class TravelPlanRequest(BaseModel):
    destination: str
    duration: str  # "3天2夜"
    interests: List[str]  # ["美食", "历史", "摄影"]
    budget: str  # "中等"
    travel_dates: Optional[str]
    travel_style: Optional[str]  # "休闲", "探险"
    group_size: Optional[int]
```

### 6.2 响应模型
```python
class TravelPlanResponse(BaseModel):
    plan_id: str
    destination: str
    itinerary: List[DailyItinerary]
    food_recommendations: List[Restaurant]
    hotels: List[Hotel]
    estimated_cost: CostBreakdown
    tips: List[str]
```

## 7. 生产部署

### 7.1 部署架构
```
┌─────────────────┐
│   负载均衡器     │  (Nginx/HAProxy)
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼──┐  ┌──▼───┐
│ API  │  │ API  │  (多实例部署)
│实例1 │  │实例2 │
└───┬──┘  └──┬───┘
    │         │
    └────┬────┘
         │
┌────────▼────────┐
│   Redis缓存     │  (结果缓存 + 限流)
└─────────────────┘
         │
┌────────▼────────┐
│  监控告警系统   │  (Prometheus + Grafana)
└─────────────────┘
```

### 7.2 Docker部署
- 多阶段构建优化镜像大小
- 健康检查配置
- 资源限制
- 环境变量管理

### 7.3 性能优化
- **缓存策略**: Redis缓存常用查询结果
- **并发控制**: Agent并行执行
- **限流保护**: API访问限流
- **连接池**: 模型API连接池
- **异步处理**: 长时任务异步化

### 7.4 监控指标
- API响应时间
- Agent执行时间
- 模型调用成功率
- 系统资源使用率
- 错误率和类型分布

## 8. 安全性

### 8.1 认证授权
- JWT Token认证
- API Key管理
- 权限分级控制

### 8.2 数据安全
- 敏感信息加密
- HTTPS传输
- 请求签名验证

### 8.3 防护措施
- SQL注入防护
- XSS防护
- CSRF防护
- 限流防DDoS

## 9. 扩展性设计

### 9.1 新Agent接入
```python
# 1. 继承BaseAgent
# 2. 实现execute方法
# 3. 在AgentManager注册
# 4. 配置工作流节点
```

### 9.2 新模型接入
```python
# 1. 实现统一模型接口
# 2. 配置模型参数
# 3. 更新环境变量
```

### 9.3 新功能扩展
- 插件化架构
- 配置驱动
- 热加载支持

## 10. 技术债务与优化方向

### 10.1 近期优化
- [ ] 增加单元测试覆盖率
- [ ] 完善API文档
- [ ] 优化提示词模板
- [ ] 增加结果缓存

### 10.2 中期规划
- [ ] 支持流式响应
- [ ] 增加向量数据库
- [ ] 知识库检索增强
- [ ] 多模型切换

### 10.3 长期规划
- [ ] Agent自主学习
- [ ] 用户偏好建模
- [ ] 实时数据接入
- [ ] 多语言支持
